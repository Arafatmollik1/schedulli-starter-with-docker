{
	# Enable HTTP/3 (QUIC) for production on HTTPS (port 443)
	# HTTP/3 uses UDP port 443 and requires TLS
	servers :443 {
		protocols h1 h2 h3
	}
	# HTTP server (port 80) only needs h1 and h2c for redirects
	servers :80 {
		protocols h1 h2c
	}
	# Email for Let's Encrypt notifications
	email {$CADDY_EMAIL}
}

# HTTP to HTTPS redirect
:80 {
	redir https://{$CADDY_DOMAIN}{uri} permanent
}

# HTTPS server with automatic HTTPS and HTTP/3
{$CADDY_DOMAIN} {
	root * /var/www/html/public

	# Automatic HTTPS with Let's Encrypt (enabled by default when domain is specified)
	# Caddy automatically provisions and renews certificates

	# Security headers
	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "no-referrer-when-downgrade"
		-Server
	}

	# Deny access to hidden files (Caddy automatically handles .well-known/acme-challenge for Let's Encrypt)
	@hidden {
		path /.well-known/*
		not path /.well-known/acme-challenge/*
	}
	handle @hidden {
		respond 404
	}

	# Deny access to storage and bootstrap directories
	@deny {
		path /storage/*
		path /bootstrap/cache/*
	}
	handle @deny {
		respond 403
	}

	# Handle static files with caching
	@static {
		file
		path *.css *.js *.jpg *.jpeg *.png *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp
	}
	handle @static {
		header Cache-Control "public, max-age=31536000, immutable"
		file_server
	}

	# Handle built Vite assets
	handle /build/* {
		header Cache-Control "public, max-age=31536000, immutable"
		file_server
	}

	# Proxy all other requests to FrankenPHP
	reverse_proxy frankenphp:8000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}

		# Timeouts
		transport http {
			dial_timeout 10s
			response_header_timeout 300s
		}
	}

	# Compression
	encode gzip zstd

	# Logging
	log {
		output stdout
		format json
	}
}
