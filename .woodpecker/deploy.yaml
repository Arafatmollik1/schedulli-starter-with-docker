when:
  - event: push
    branch: master

steps:
  - name: build-frontend
    image: node:20-alpine
    environment:
      CI: "true"
    commands:
      - npm ci
      - npm run build
      - echo "Frontend build completed"

  - name: deploy-to-production
    image: alpine:latest
    environment:
      DEPLOY_HOST:
        from_secret: deploy_host
      DEPLOY_USER:
        from_secret: deploy_user
      DEPLOY_SSH_KEY:
        from_secret: deploy_ssh_key
      DEPLOY_PATH:
        from_secret: deploy_path
    commands:
      # Setup SSH
      - apk add --no-cache openssh-client rsync
      - mkdir -p ~/.ssh
      - echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
      
      # Deploy code to server
      - echo "Deploying to $DEPLOY_HOST:$DEPLOY_PATH"
      
      # Stop containers
      - echo "Stopping containers..."
      - |
        ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
          "cd ${DEPLOY_PATH} && docker compose -f docker-compose.prod.yml down 2>/dev/null || true"
      
      # Clean up build directory
      - echo "Cleaning up public/build directory..."
      - |
        ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
          "rm -rf ${DEPLOY_PATH}/public/build 2>/dev/null || true"
      
      # Sync files with rsync
      - echo "Syncing files to server..."
      - |
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='storage/logs/*' \
          --exclude='storage/framework/sessions/*' \
          --exclude='storage/framework/cache/*' \
          --exclude='.env' \
          ./ \
          "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/"
      
      # Verify deployment files
      - echo "Verifying deployment files..."
      - |
        ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
          "ls -la ${DEPLOY_PATH}/docker/entrypoint.sh"
      
      # Run deployment script on server
      - echo "Running deployment script..."
      - |
        ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
          "cd ${DEPLOY_PATH} && ./deploy.sh"
      
      - echo "Deployment completed successfully!"